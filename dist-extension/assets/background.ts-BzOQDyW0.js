async function w(e){return new Promise(o=>{chrome.storage.local.get(e,a=>{o(a)})})}async function I(e){return new Promise(o=>{chrome.storage.local.set(e,()=>{o()})})}async function T(e){const{activeSessions:o=[]}=await w(["activeSessions"]);o.includes(e)||await I({activeSessions:[...o,e]})}async function k(e){const{activeSessions:o=[]}=await w(["activeSessions"]),a=o.filter(c=>c!==e);await I({activeSessions:a})}async function N(){const{activeSessions:e=[]}=await w(["activeSessions"]);return e.length}let n=null,g=null;const f=5e3,m="ws://localhost:8129",u=new Set;console.log("Terminal Tabs background service worker starting...");function y(){if((n==null?void 0:n.readyState)===WebSocket.OPEN){console.log("WebSocket already connected");return}console.log("Connecting to backend WebSocket:",m),n=new WebSocket(m),n.onopen=()=>{console.log("âœ… Background WebSocket connected"),S(),s({type:"WS_CONNECTED"})},n.onmessage=e=>{var o,a,c;try{const t=JSON.parse(e.data);if(console.log("ğŸ“¨ WS message received:",t.type,t.type==="terminal-spawned"?JSON.stringify(t).slice(0,200):""),t.type==="output"||t.type==="terminal-output")console.log("ğŸ“Ÿ Terminal output received, broadcasting to clients:",(o=t.terminalId)==null?void 0:o.slice(-8),(a=t.data)==null?void 0:a.length,"bytes"),s({type:"TERMINAL_OUTPUT",terminalId:t.terminalId,data:t.data});else if(t.type==="terminals")console.log("ğŸ“‹ Terminal list received:",(c=t.data)==null?void 0:c.length,"terminals"),s({type:"WS_MESSAGE",data:t});else{const r={type:"WS_MESSAGE",data:t};t.type==="terminal-spawned"&&console.log("ğŸ“¤ Broadcasting to clients:",JSON.stringify(r).slice(0,200)),s(r)}}catch(t){console.error("Failed to parse WebSocket message:",t)}},n.onerror=e=>{console.error("âŒ WebSocket error:",{url:m,readyState:n==null?void 0:n.readyState,readyStateText:(n==null?void 0:n.readyState)===0?"CONNECTING":(n==null?void 0:n.readyState)===1?"OPEN":(n==null?void 0:n.readyState)===2?"CLOSING":(n==null?void 0:n.readyState)===3?"CLOSED":"UNKNOWN",error:e})},n.onclose=e=>{console.log("WebSocket closed:",{code:e.code,reason:e.reason||"(no reason provided)",wasClean:e.wasClean,url:m}),n=null,s({type:"WS_DISCONNECTED"}),g&&clearTimeout(g),g=setTimeout(y,f)}}function i(e){(n==null?void 0:n.readyState)===WebSocket.OPEN?n.send(JSON.stringify(e)):console.warn("WebSocket not connected, cannot send:",e)}function s(e){u.forEach(o=>{try{o.postMessage(e)}catch(a){console.error("Failed to send message to client:",a),u.delete(o)}})}async function S(){const e=await N();chrome.action.setBadgeText({text:e>0?String(e):""}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})}chrome.runtime.onMessage.addListener(async(e,o,a)=>{var c;switch(console.log("ğŸ“¬ Message received from extension:",e.type),e.type){case"OPEN_SESSION":try{const d=await chrome.windows.getAll({windowTypes:["normal"]}),l=d.find(E=>E.focused)||d[0];l!=null&&l.id?(console.log("[Background] Opening side panel in window:",l.id),await chrome.sidePanel.open({windowId:l.id})):console.error("[Background] No normal browser window found")}catch(d){console.error("[Background] Failed to open side panel:",d)}i({type:"attach-terminal",sessionName:e.sessionName});break;case"SPAWN_TERMINAL":const t=`spawn-${Date.now()}`,{settings:r}=await w(["settings"]),p=(r==null?void 0:r.globalUseTmux)||!1;i({type:"spawn",config:{terminalType:e.spawnOption||"bash",command:e.command||"",workingDir:e.cwd,useTmux:p||e.useTmux||!1,name:e.name||e.spawnOption||"Terminal"},requestId:t}),console.log("ğŸ“¤ Spawning terminal:",{terminalType:e.spawnOption,name:e.name,command:e.command,cwd:e.cwd,useTmux:p||e.useTmux||!1,globalUseTmux:p,requestId:t}),e.spawnOption&&(T(`${e.spawnOption}-${Date.now()}`),S());break;case"CLOSE_SESSION":i({type:"close-terminal",sessionName:e.sessionName}),k(e.sessionName),S();break;case"CLOSE_TERMINAL":i({type:"close-terminal",terminalId:e.terminalId});break;case"TERMINAL_INPUT":console.log("ğŸ“¥ TERMINAL_INPUT:",{terminalId:e.terminalId,dataLength:(c=e.data)==null?void 0:c.length}),i({type:"command",terminalId:e.terminalId,command:e.data});break;case"TERMINAL_RESIZE":console.log("ğŸ“ TERMINAL_RESIZE:",{terminalId:e.terminalId,cols:e.cols,rows:e.rows}),i({type:"resize",terminalId:e.terminalId,cols:e.cols,rows:e.rows});break;case"UPDATE_BADGE":S();break;case"REFRESH_TERMINALS":console.log("ğŸ”„ Broadcasting REFRESH_TERMINALS to all clients"),s({type:"REFRESH_TERMINALS"});break;default:i(e)}return!0});chrome.runtime.onConnect.addListener(e=>{console.log("ğŸ”Œ Client connected:",e.name),u.add(e);const o=(n==null?void 0:n.readyState)===WebSocket.OPEN;e.postMessage({type:"INITIAL_STATE",wsConnected:o}),e.onDisconnect.addListener(()=>{console.log("ğŸ”Œ Client disconnected:",e.name),u.delete(e)}),e.onMessage.addListener(a=>{chrome.runtime.sendMessage(a)})});chrome.runtime.onInstalled.addListener(()=>{console.log("Installing context menus..."),chrome.contextMenus.create({id:"open-sidepanel",title:"Open Terminal Sidebar",contexts:["all"]})});chrome.contextMenus.onClicked.addListener((e,o)=>{console.log("Context menu clicked:",e.menuItemId),e.menuItemId==="open-sidepanel"&&(o!=null&&o.windowId)&&chrome.sidePanel.open({windowId:o.windowId})});chrome.action.onClicked.addListener(async e=>{if(console.log("ğŸ–±ï¸ Extension icon clicked"),e.windowId)try{await chrome.sidePanel.open({windowId:e.windowId}),console.log("[Background] Opened sidebar via icon click")}catch(o){console.error("[Background] Failed to open sidebar:",o)}});chrome.commands.onCommand.addListener(async e=>{if(console.log("âŒ¨ï¸ Keyboard command:",e),e==="toggle-sidebar")try{const o=await chrome.windows.getAll({windowTypes:["normal"]}),a=o.find(c=>c.focused)||o[0];a!=null&&a.id?(console.log("[Background] Toggling sidebar in window:",a.id),await chrome.sidePanel.open({windowId:a.id})):console.error("[Background] No normal browser window found")}catch(o){console.error("[Background] Failed to toggle sidebar:",o)}});y();setInterval(()=>{console.log("ğŸ“ Background service worker alive"),(n==null?void 0:n.readyState)!==WebSocket.OPEN&&y()},25e3);console.log("âœ… Terminal Tabs background service worker initialized");
