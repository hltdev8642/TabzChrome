# TabzChrome Codebase Audit Report
**Date**: December 23, 2025
**Version**: 1.2.8
**Audit Method**: Parallel Opus agents across 5 codebase areas

---

## Executive Summary

This comprehensive audit examined the TabzChrome codebase across 5 areas: Extension Frontend, Backend Server, MCP Server, Plugins/Skills, and Documentation. The codebase is generally well-structured but has accumulated technical debt, particularly in file sizes and documentation sync.

### Critical Findings

| Priority | Issue | Area |
|----------|-------|------|
| CRITICAL | `background.ts` is 4,537 lines | Extension |
| HIGH | Security: Command injection risk in tmux commands | Backend |
| HIGH | Tool count inconsistent across docs (20/26/29) | Documentation |
| HIGH | `.claude/skills/tabz-guide/` outdated vs `plugins/` | Plugins |
| MEDIUM | `createPendingRequest()` defined but never used | Backend |
| MEDIUM | CDP references remain despite removal | Docs/MCP |

---

## 1. Extension Frontend Audit

### Huge Files (Must Split)

| File | Lines | Priority |
|------|-------|----------|
| `extension/background/background.ts` | 4,537 | **CRITICAL** |
| `extension/sidepanel/sidepanel.tsx` | 1,442 | HIGH |
| `extension/components/settings/ProfilesTab.tsx` | 1,113 | MEDIUM |
| `extension/components/Terminal.tsx` | 1,074 | MEDIUM |

**Recommended Split for `background.ts`:**
```
extension/background/
  index.ts           # Entry point
  websocket.ts       # WebSocket connection
  consoleCapture.ts  # Console log storage
  networkCapture.ts  # Browser debugger
  messageHandlers.ts # Chrome message handlers
  contextMenus.ts    # Context menu handlers
  omnibox.ts         # Omnibox commands
  keyboard.ts        # Keyboard shortcuts
  alarms.ts          # Cleanup tasks
  badge.ts           # Badge updates
```

### Duplicated Patterns

1. **`getValidWindowId`** - Repeated 5+ times in background.ts
2. **Sidebar open with fallback** - Same try/catch pattern 7+ times
3. **Audio play logic** - Similar code in ProfilesTab, AudioTab, useAudioNotifications

### Other Issues

- **API_BASE inconsistent**: Some files use `BACKEND_URL`, others hardcode `localhost:8129`
- **Non-typed catch clauses**: Many `catch (e)` without explicit type
- **setTimeout without cleanup**: Missing cleanup in effects

---

## 2. Backend Server Audit

### Huge Files

| File | Lines | Action |
|------|-------|--------|
| `backend/routes/api.js` | 1,840 | Split into route groups |
| `backend/routes/browser.js` | 1,769 | Use existing helper function |
| `backend/server.js` | 1,745 | Extract WebSocket handlers |
| `backend/routes/files.js` | 1,011 | Acceptable |

### Security Issues (HIGH PRIORITY)

1. **Command Injection Risk** (`api.js` lines 854, 882, 916, 985)
   ```javascript
   // CURRENT (vulnerable)
   execSync(`tmux kill-session -t "${sessionName}" 2>/dev/null`);

   // FIX: Use spawnSync with argument arrays
   spawnSync('tmux', ['kill-session', '-t', sessionName], { stdio: 'pipe' });
   ```

2. **Auth Token in Query String** (`server.js` line 531)
   - Remove `|| req.query.token` - accept only via header

3. **Weak Session Name Validation** (`api.js` lines 1483-1485)
   - Add regex validation: `/^ctt-[a-z0-9-]{8,50}$/`

### Duplicated Code

1. **`expandTilde()`** - 3 different implementations
   - `pty-handler.js` (lines 24-51)
   - `terminal-registry.js` (lines 32-43)
   - `files.js` (lines 283-288)
   - **Fix**: Create `modules/path-utils.js`

2. **`createPendingRequest()`** - Defined at browser.js:61-82 but **never used**
   - All 25 routes reimplement the same pattern inline

3. **VOICE_OPTIONS array** - Defined twice in server.js

---

## 3. MCP Server Audit

### Huge Files

| File | Lines | Action |
|------|-------|--------|
| `tabz-mcp-server/src/client.ts` | 1,041 | Split into domain modules |

**Recommended Split:**
```
src/client/
  index.ts       # Re-export
  core.ts        # Tab management
  screenshot.ts  # Screenshots
  interaction.ts # Click, fill
  network.ts     # Network capture
  downloads.ts   # Downloads
  bookmarks.ts   # Bookmarks
  debugger.ts    # DOM, coverage
```

### Duplicated Code

- **`formatBytes()`** - Duplicated 3 times (network.ts, downloads.ts, debugger.ts)
- **`BookmarkNode` type** - Duplicated in types.ts and bookmarks.ts

### Dead Code

- `cleanupScreenshots()` - Defined but never called
- `convertPathForWSL()` - Defined but never called
- Commented tool groups in index.ts (cookies, history)

### Documentation Mismatch

Error messages still reference CDP despite removal:
- "Ensure Chrome is running with: --remote-debugging-port=9222"
- "CDP not available"

**Fix**: Update to "Ensure TabzChrome extension is installed and backend is running"

---

## 4. Plugins & Skills Audit

### Duplication Issues

**`.claude/skills/tabz-guide/` is OUTDATED:**

| File | `.claude/` says | `plugins/` says | Actual |
|------|-----------------|-----------------|--------|
| SKILL.md | "20 tools" | "29 tools" | 29 |
| mcp-tools.md | "26 tools" | "26 tools" | 29 |
| changelog.md | Stops at 1.1.16 | Includes 1.2.8 | 1.2.8 |

**Fix:**
```bash
rm -rf .claude/skills/tabz-guide
cp -r plugins/tabz-guide/skills/tabz-guide .claude/skills/
```

### Structure Inconsistency

**tabz-guide uses wrong plugin structure:**
- Has `.claude-plugin/plugin.json` (just fixed)
- All other plugins use `plugin.json` at root

**Note**: This was fixed earlier in this session.

### Safelist References Missing Skills

`.claude/skills/.safelist` protects `xterm-js` and `tabz-mcp` but they don't exist in `.claude/skills/`.

---

## 5. Documentation Audit

### Tool Count Inconsistencies (HIGH PRIORITY)

| Location | Claims | Actual |
|----------|--------|--------|
| README.md (line 453) | "20 MCP tools" | 29 |
| .claude/skills/tabz-guide/SKILL.md | "20 tools" | 29 |
| docs/PLUGIN.md | "26 tools" | 29 |
| MCP_TOOLS.md | "29 tools" | 29 ✓ |

### CDP References to Remove

These files still reference CDP despite removal:
- `docs/PLUGIN.md` - Setup instructions for `--remote-debugging-port=9222`
- `MCP_TOOLS.md` - Architecture diagram shows CDP section

### Stale Planning Documents

| File | Status |
|------|--------|
| `docs/planning/BROWSER_MCP_SERVER_PLAN.md` | **COMPLETED** |
| `docs/planning/context-window-status.md` | **COMPLETED** |
| `docs/planning/SELECTED_TEXT_FEATURE.md` | **COMPLETED** |
| `docs/planning/MISSING_FEATURES.md` | **PARTIALLY STALE** |

### CHANGELOG Rotation Required

CHANGELOG.md is 793 lines - exceeds 500-line rotation policy.

### README Version Badge Outdated

Shows 1.1.8, should be 1.2.8.

---

## Prioritized Action Items

### Tomorrow - High Priority

1. **Fix security issues in backend**
   - Switch tmux commands to `spawnSync` with argument arrays
   - Remove auth token from query string
   - Add session name regex validation

2. **Update tool counts in documentation**
   - README.md: Change "20" to "29"
   - docs/PLUGIN.md: Change "26" to "29"
   - All skill files: Update to "29"

3. **Sync `.claude/skills/tabz-guide/`** from `plugins/`

### This Week - Medium Priority

4. **Split `background.ts`** (4,537 lines → 10 modules)

5. **Remove CDP references** from:
   - docs/PLUGIN.md
   - MCP_TOOLS.md architecture diagram
   - Error messages in MCP tools

6. **Use existing `createPendingRequest()`** in browser.js routes

7. **Create shared utilities**:
   - `modules/path-utils.js` for `expandTilde()`
   - `src/utils/formatters.ts` for `formatBytes()`

### Cleanup - Low Priority

8. **Rotate CHANGELOG** - Move pre-1.1.0 to archive

9. **Archive completed planning docs**

10. **Update README version badge** to 1.2.8

11. **Remove dead code**:
    - `cleanupScreenshots()` in client.ts
    - `convertPathForWSL()` in client.ts
    - Commented tool groups in index.ts

---

## Metrics Summary

| Area | Files Audited | Issues Found |
|------|---------------|--------------|
| Extension Frontend | 15+ | 12 |
| Backend Server | 7 | 18 |
| MCP Server | 10+ | 15 |
| Plugins/Skills | 9 plugins | 6 |
| Documentation | 20+ | 10 |
| **Total** | **60+** | **61** |

| Severity | Count |
|----------|-------|
| Critical | 1 |
| High | 6 |
| Medium | 15 |
| Low | 39 |

---

*Generated by parallel Opus audit agents - December 23, 2025*
